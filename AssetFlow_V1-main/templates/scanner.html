{% extends "base.html" %}

{% block title %}Article Scanner{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
  body { background: #f8f9fa; padding: 20px; }
  #reader { width: 100%; max-width: 420px; margin: 0 auto 20px; }
  #resultBox { margin-top: 10px; padding: 10px; background: #fff; border-radius: 6px; 
               box-shadow: 0 0 6px rgb(0 0 0 / 10%); font-size: 1.1rem; min-height: 50px; }
  .form-section { background: #fff; padding: 15px; border-radius: 6px; margin-top: 20px; 
                  box-shadow: 0 0 6px rgb(0 0 0 / 10%); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Scanner</h1>
  </div>

  <!-- QR/Barcode Scanner -->
  <div id="reader"></div>
  <div class="d-flex justify-content-center mb-3">
    <button id="btnStartQR" class="btn btn-primary w-50">Start Scan</button>
  </div>
  <div id="resultBox" class="text-center">Scanned barcode will appear here</div>

  <!-- Article Form -->
  <div class="form-section">
    <form method="POST" id="scannerForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
      <div class="row"></div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Matricule</label>
          <!-- Matricule -->
<input type="text" id="matriculeInput" name="matricule" class="form-control" readonly>

        </div>

        <!-- Zone -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Zone</label>
                        <!-- Zone -->
<select name="zone" id="zoneSelect" class="form-select" required>
  <option value="">Select Zone</option>
  {% for z in zones %}
    <option value="{{ z.id }}" {% if article and article.zone_id == z.id %}selected{% endif %}>{{ z.nom }}</option>
  {% endfor %}
</select>
                    </div>

                    <!-- Site -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Site</label>
                        <!-- Site -->
<select name="site" id="siteSelect" class="form-select" required>
  <option value="">Select Site</option>
  {% for s in sites %}
    <option value="{{ s.id }}" {% if article and article.site_id == s.id %}selected{% endif %}>{{ s.nom }}</option>
  {% endfor %}
</select>

                    </div>

                    <!-- Local -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Local</label>
                        <!-- Local -->
<select name="local" id="localSelect" class="form-select">
  <option value="">Select Local</option>
  {% for l in locaux %}
    <option value="{{ l.id }}" {% if article and article.local_id == l.id %}selected{% endif %}>{{ l.nom }}</option>
  {% endfor %}
</select>

                    </div>

                    <!-- Affect√© √† -->
<div class="col-md-4 mb-3">
    <label class="form-label">Affect√© √†</label>
    <select name="affecte_a" id="affecteSelect" class="form-select" required>
        <option value="">Select Salari√©</option>
        {% for salarie in salaries %}
            <option value="{{ salarie.nom_prenom }}" {% if article and article.affecte_a == salarie.nom_prenom %}selected{% endif %}>
                {{ salarie.nom_prenom }}
            </option>
        {% endfor %}
    </select>
</div>

                    <!-- Zone d'affectation 
                    <div class="col-md-4">
                        <label class="form-label">Zone d'affectation</label>
                        <input type="text" name="zone_affectation" class="form-control" value="{{ article.zone_affectation if article else '' }}">
                    </div>
                -->

                    <div class="col-md-4 mb-3">
                        <label class="form-label">Code QR/Bar</label>
                          <div id="qrDisplay" class="form-control bg-light text-center" style="height: 38px;">
                            {{ article.qr_code if article else 'Scan a Code QR/Bar'}}
                        </div>
                         <input type="hidden" name="qr_code" id="qrInput" value="{{ article.qr_code if article else '' }}">
                        </div>

                    <!-- Famille -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Famille</label>
                        <!-- Famille (add data-code so we can build the matricule) -->
<select name="famille" class="form-select" id="familleSelect" required>
  <option value="">Select Famille</option>
  {% for f in familles %}
    <option
      value="{{ f.id }}"
      data-code="{{ (f.code if (f is defined and f.code is defined and f.code) else (f.nom[:3]|upper)) }}"
      {% if article and article.famille_id == f.id %}selected{% endif %}
    >
      {{ f.nom }}
    </option>
  {% endfor %}
</select>
                    </div>

                    <!-- Sous-Famille -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Sous-Famille</label>
                        <!-- Sous-Famille -->
<select name="sous_famille" class="form-select" id="sousFamilleSelect" required>
  <option value="">Select Sous-Famille</option>
</select></select>
                    </div>

                    <!-- D√©signation -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">D√©signation</label>
                        <input type="text" name="designation" class="form-control" value="{{ article.designation if article else '' }}">
                    </div>

                    <!-- N¬∞ de s√©rie -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">N¬∞ de s√©rie</label>
                        <input type="text" name="serial_number" class="form-control" value="{{ article.serial_number if article else '' }}">
                    </div>

                    <!-- Marque -->
<div class="col-md-4 mb-3">
    <label class="form-label">Marque</label>
    <input type="text" name="marque" id="marqueInput" class="form-control" value="">
</div>

<!-- Mod√®le -->
<div class="col-md-4 mb-3">
    <label class="form-label">Mod√®le</label>
    <input type="text" name="modele" id="modeleInput" class="form-control" value="">
</div>

<!-- Statut -->
<div class="col-md-4 mb-3">
    <label class="form-label">Statut</label>
    <select name="statut" id="statutSelect" class="form-select" required>
        <option value="">Select Statut</option>
        <option value="En cours d'utilisation" {% if article and article.statut == "En cours d'utilisation" %}selected{% endif %}>En cours d'utilisation</option>
        <option value="EN Panne" {% if article and article.statut == 'EN Panne' %}selected{% endif %}>En panne</option>     
        <option value="En maintenance" {% if article and article.statut == 'En maintenance' %}selected{% endif %}>En reparation</option>
        <option value="Hors Services" {% if article and article.statut == 'Hors Services' %}selected{% endif %}>Hors services</option>
    </select>
</div>


                    <!-- Image 
                    <div class="col-md-4">
                        <label class="form-label">Image</label>
                        <input type="file" name="image" class="form-control">
                        {% if article and article.image %}
                            <img src="{{ url_for('static', filename='uploads/' ~ article.image) }}" alt="Article" class="article-img mt-2">
                        {% endif %}
                    </div>
                </div>
                -->
                </div>


        <input type="hidden" name="barcode" id="barcodeInput">

        <button type="submit" class="btn btn-success w-100 mt-2">üíæ Save Article</button>
    </form>
  </div>

  <!-- History Section -->
  <div class="form-section mt-4">
    <h5>Recent Articles</h5>
    <ul class="list-group">
      {% for article in articles %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ article.designation }}</strong> 
          <span class="text-muted">({{ article.matricule }})</span>
        </div>
        <div class="d-flex align-items-center">
          <small class="text-muted me-3">
            {{ article.timestamp.strftime("%Y-%m-%d %H:%M") }}
          </small>
        </div>
      </li>
      {% else %}
      <li class="list-group-item text-muted">No articles found.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>

<!-- (Optional) Select2 JS if you‚Äôre using it for ‚ÄúAffect√© √†‚Äù -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



<script>
document.addEventListener("DOMContentLoaded", function () {
  // ------- Elements -------
  const zoneSelect        = document.getElementById("zoneSelect");
  const siteSelect        = document.getElementById("siteSelect");
  const localSelect       = document.getElementById("localSelect");
  const familleSelect     = document.getElementById("familleSelect");
  const sousFamilleSelect = document.getElementById("sousFamilleSelect");
  const matriculeInput    = document.getElementById("matriculeInput");
  const barcodeInput      = document.getElementById("barcodeInput");
  const resultBox         = document.getElementById("resultBox");
  const btnStartQR        = document.getElementById("btnStartQR");

  const designationInput  = document.querySelector("[name='designation']");
  const serialInput       = document.querySelector("[name='serial_number']");
  const marqueInput       = document.getElementById("marqueInput");
  const modeleInput       = document.getElementById("modeleInput");
  const statutSelect      = document.getElementById("statutSelect");
  const affecteSelect     = document.getElementById("affecteSelect");

  // Sous-familles data from Flask
  const sousFamilles = {{ sous_familles | tojson | safe }};

  // -------- Helpers --------
  function slugUpper(text) {
    if (!text) return "";
    return text.normalize("NFD")
               .replace(/[\u0300-\u036f]/g, "")
               .replace(/[^A-Za-z0-9]/g, "")
               .toUpperCase();
  }

  function randomDigits(n = 8) {
    let s = "";
    for (let i = 0; i < n; i++) s += Math.floor(Math.random() * 10);
    return s;
  }

  function getSelectedText(selectEl) {
    if (!selectEl) return "";
    const opt = selectEl.options[selectEl.selectedIndex];
    return opt ? opt.text : "";
  }

  function getFamilleCode() {
    const opt = familleSelect.options[familleSelect.selectedIndex];
    return opt?.dataset.code?.toUpperCase() || "FAM";
  }

  function generateMatriculeFromSelections() {
    const zoneName    = slugUpper(getSelectedText(zoneSelect)) || "ZONE";
    const familleCode = getFamilleCode();
    const digits      = randomDigits(8);
    return `${zoneName}-${familleCode}${digits}`;
  }

  function updateSousFamilleOptions() {
    if (!familleSelect || !sousFamilleSelect) return;
    const selectedFamilleId = familleSelect.value;
    sousFamilleSelect.innerHTML = '<option value="">Select Sous-Famille</option>';
    sousFamilles
      .filter(sf => String(sf.famille_id) === String(selectedFamilleId))
      .forEach(sf => {
        const opt = document.createElement("option");
        opt.value = sf.id;
        opt.textContent = sf.nom;
        sousFamilleSelect.appendChild(opt);
      });
  }

  // ------- Wire up dependent selects -------
  familleSelect.addEventListener("change", () => {
    updateSousFamilleOptions();
    matriculeInput.value = generateMatriculeFromSelections();
  });

  zoneSelect.addEventListener("change", () => {
    matriculeInput.value = generateMatriculeFromSelections();
  });

  // Initialize sous-familles on load
  updateSousFamilleOptions();
  if (!matriculeInput.value) {
    matriculeInput.value = generateMatriculeFromSelections();
  }

  // ------- QR scanner -------
  let html5QrCode = null;

  function onScanSuccess(decodedText) {
    resultBox.textContent = "Scanned: " + decodedText;

    const qrDisplay = document.getElementById("qrDisplay");
    const qrInput   = document.getElementById("qrInput");
    if (qrDisplay) qrDisplay.innerText = decodedText;
    if (qrInput)   qrInput.value       = decodedText;
    if (barcodeInput) barcodeInput.value = decodedText;

    // Fetch article data
    fetch(`/article/get/${encodeURIComponent(decodedText)}`)
      .then(r => r.json())
      .then(data => {
        if (data && !data.message) {
          // Pre-fill all fields from DB
          if (siteSelect)        siteSelect.value        = data.site_id || "";
          if (zoneSelect)        zoneSelect.value        = data.zone_id || "";
          if (localSelect)       localSelect.value       = data.local_id || "";
          if (familleSelect)     familleSelect.value     = data.famille_id || "";
          updateSousFamilleOptions();
          if (sousFamilleSelect) sousFamilleSelect.value = data.sous_famille_id || "";

          if (designationInput) designationInput.value   = data.designation || "";
          if (serialInput)      serialInput.value        = data.serial_number || "";
          if (marqueInput)      marqueInput.value        = data.marque || "";
          if (modeleInput)      modeleInput.value        = data.modele || "";
          if (statutSelect)     statutSelect.value       = data.statut || "";
          if (affecteSelect) {
    console.log("affecte_a from backend:", data.affecte_a);
    affecteSelect.value = data.affecte_a || "";
    if (![...affecteSelect.options].some(opt => opt.value === data.affecte_a)) {
        affecteSelect.value = "";
      }
      }    

          matriculeInput.value = data.matricule || generateMatriculeFromSelections();
        } else {
          // New article ‚Üí generate a fresh matricule
          matriculeInput.value = generateMatriculeFromSelections();
        }
      })
      .catch(() => {
        matriculeInput.value = generateMatriculeFromSelections();
      })
      .finally(() => {
        if (html5QrCode) {
          html5QrCode.stop().then(() => {
            html5QrCode.clear();
            html5QrCode = null;
            btnStartQR.textContent = "Start Scan";
          });
        }
      });
  }

  function onScanError(_) { /* ignore */ }

  btnStartQR.addEventListener("click", function () {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
        btnStartQR.textContent = "Start Scan";
      });
    } else {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanError
      ).then(() => {
        btnStartQR.textContent = "Stop Scan";
      }).catch(err => {
        console.error(err);
        btnStartQR.textContent = "Start Scan";
      });
    }
  });

  // ------- Enhance "Affect√© √†" with Select2 -------
  if (window.jQuery && $('#affecteSelect').length) {
    $('#affecteSelect').select2({ placeholder: "Select Salari√©", allowClear: true, width: '100%' });
  }
});
</script>
{% endblock %}